<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test Connection - setuptrip ‚Üí tripprogress</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      background: #020617;
      color: #e5e7eb;
    }
    .test-section {
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .test-btn {
      background: #22c55e;
      color: #022c22;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
    }
    .test-btn:hover {
      background: #16a34a;
    }
    .result {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      background: #0f172a;
    }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <h1>üîó Connection Test: setuptrip.html ‚Üí tripprogress.html</h1>

  <div class="test-section">
    <h2>Test 1: Save Trip to localStorage</h2>
    <button class="test-btn" onclick="testSaveTrip()">Save Test Trip</button>
    <div id="test1-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Navigate to tripprogress.html</h2>
    <button class="test-btn" onclick="testNavigation()">Navigate to Trip Progress</button>
    <div id="test2-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Full Flow Test</h2>
    <button class="test-btn" onclick="testFullFlow()">Save Trip & Navigate</button>
    <div id="test3-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Quick Links</h2>
    <a href="setuptrip.html"><button class="test-btn">Open Setup Trip</button></a>
    <a href="tripprogress.html"><button class="test-btn">Open Trip Progress</button></a>
    <button class="test-btn" onclick="clearStorage()">Clear localStorage</button>
  </div>

  <script>
    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      el.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
    }

    function testSaveTrip() {
      const result = document.getElementById('test1-result');
      result.innerHTML = '';
      
      try {
        const testTrip = {
          from: 'Mysuru Palace',
          to: 'Chamundi Hills',
          radius: 5,
          start: '2025-12-12 10:00',
          end: '2025-12-12 16:00',
          travellers: 2,
          mode: 'Taxi',
          notes: 'Test trip',
          status: 'active',
          startedAt: new Date().toISOString()
        };

        localStorage.setItem('activeTrip', JSON.stringify(testTrip));
        log('test1-result', '‚úÖ Trip saved to localStorage', 'success');
        
        const retrieved = localStorage.getItem('activeTrip');
        if (retrieved) {
          const parsed = JSON.parse(retrieved);
          log('test1-result', `‚úÖ Retrieved: ${parsed.from} ‚Üí ${parsed.to}`, 'success');
        }
      } catch (e) {
        log('test1-result', `‚ùå Error: ${e.message}`, 'error');
      }
    }

    function testNavigation() {
      const result = document.getElementById('test2-result');
      result.innerHTML = '';
      
      log('test2-result', 'Testing navigation to tripprogress.html...', 'info');
      
      fetch('tripprogress.html', { method: 'GET', credentials: 'same-origin' })
        .then(response => {
          if (response.ok) {
            log('test2-result', `‚úÖ tripprogress.html is accessible (status: ${response.status})`, 'success');
            log('test2-result', `URL: ${response.url}`, 'info');
            
            // Check if redirected
            if (response.redirected) {
              log('test2-result', `‚ö†Ô∏è WARNING: Response was redirected to ${response.url}`, 'error');
            } else {
              log('test2-result', '‚úÖ No redirect detected - direct access works!', 'success');
            }
          } else {
            log('test2-result', `‚ùå Failed to load: status ${response.status}`, 'error');
          }
        })
        .catch(err => {
          log('test2-result', `‚ùå Network error: ${err.message}`, 'error');
        });
    }

    function testFullFlow() {
      const result = document.getElementById('test3-result');
      result.innerHTML = '';
      
      log('test3-result', 'Starting full flow test...', 'info');
      
      // Step 1: Save trip
      const testTrip = {
        from: 'Test Start',
        to: 'Test End',
        radius: 10,
        start: '2025-12-15 09:00',
        end: '2025-12-15 18:00',
        travellers: 1,
        mode: 'Taxi',
        notes: 'Full flow test',
        status: 'active',
        startedAt: new Date().toISOString()
      };
      
      try {
        localStorage.setItem('activeTrip', JSON.stringify(testTrip));
        log('test3-result', '‚úÖ Step 1: Trip saved', 'success');
        
        // Step 2: Wait a moment then navigate
        setTimeout(() => {
          log('test3-result', '‚úÖ Step 2: Navigating in 1 second...', 'info');
          setTimeout(() => {
            window.location.href = 'tripprogress.html';
          }, 1000);
        }, 100);
      } catch (e) {
        log('test3-result', `‚ùå Error: ${e.message}`, 'error');
      }
    }

    function clearStorage() {
      localStorage.removeItem('activeTrip');
      alert('localStorage cleared!');
    }

    // On load, check if there's an active trip
    window.addEventListener('DOMContentLoaded', function() {
      const activeTrip = localStorage.getItem('activeTrip');
      if (activeTrip) {
        const trip = JSON.parse(activeTrip);
        document.body.insertAdjacentHTML('afterbegin', 
          `<div class="test-section" style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e;">
            <h3>‚ÑπÔ∏è Active Trip Found in localStorage</h3>
            <p><strong>From:</strong> ${trip.from} ‚Üí <strong>To:</strong> ${trip.to}</p>
            <p><strong>Started:</strong> ${new Date(trip.startedAt).toLocaleString()}</p>
          </div>`
        );
      }
    });
  </script>
</body>
</html>
